<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COVID-19 Rates Choropleth (2020)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Page + Map Styling -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    h2 {
      text-align: center;
      margin: 10px 0;
    }

    .info {
      max-width: 900px;
      margin: 0 auto 8px auto;
      padding: 0 12px;
      font-size: 13px;
      color: #333;
    }

    #map {
      height: 88vh;
      width: 100%;
      background: #cfe8ff;
    }

    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      font-size: 12px;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <h2>COVID-19 Rates by County (2020)</h2>

  <div class="info">
    <b>Map type:</b> Choropleth (county polygons). Hover to highlight, click for details.<br>
    <b>Data:</b> US county-level COVID-19 rates (2020).
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4 + Proj4Leaflet (Albers) -->
  <script src="https://unpkg.com/proj4@2.9.1/dist/proj4.js"></script>
  <script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js"></script>

  <script>
    // ===============================
    // Albers Equal Area (EPSG:5070)
    // ===============================
    const crs = new L.Proj.CRS(
      "EPSG:5070",
      "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs",
      {
        resolutions: [8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1]
      }
    );

    const map = L.map("map", { crs: crs }).setView([37.8, -96], 4);

    // ===============================
    // Choropleth Styling
    // ===============================
    const RATE_FIELD = "rate";

    function getColor(d) {
      return d > 50 ? "#800026" :
             d > 40 ? "#BD0026" :
             d > 30 ? "#E31A1C" :
             d > 20 ? "#FC4E2A" :
             d > 10 ? "#FD8D3C" :
             d > 0  ? "#FEB24C" :
                      "#FFEDA0";
    }

    function style(feature) {
      return {
        fillColor: getColor(feature.properties[RATE_FIELD]),
        weight: 0.6,
        opacity: 1,
        color: "#555",
        fillOpacity: 0.75
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 2,
        color: "#000",
        fillOpacity: 0.9
      });
      layer.bringToFront();
    }

    function resetHighlight(e) {
      geojson.resetStyle(e.target);
    }

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight
      });

      layer.bindPopup(
        `<b>${feature.properties.county}, ${feature.properties.state}</b><br>
         COVID-19 Rate: ${feature.properties[RATE_FIELD]}`
      );
    }

    // ===============================
    // Load GeoJSON
    // ===============================
    let geojson;

    fetch("assets/us-covid-2020-rates.geojson")
      .then(response => response.json())
      .then(data => {
        geojson = L.geoJSON(data, {
          style: style,
          onEachFeature: onEachFeature
        }).addTo(map);
      })
      .catch(err => console.error("GeoJSON load error:", err));

    // ===============================
    // Legend
    // ===============================
    const legend = L.control({ position: "bottomright" });

    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      const grades = [0, 10, 20, 30, 40, 50];

      div.innerHTML = "<b>Rate</b><br>";

      for (let i = 0; i < grades.length; i++) {
        div.innerHTML +=
          `<i style="background:${getColor(grades[i] + 1)}"></i> ` +
          grades[i] +
          (grades[i + 1] ? `&ndash;${grades[i + 1]}<br>` : "+");
      }

      return div;
    };

    legend.addTo(map);
  </script>
</body>
</html>
